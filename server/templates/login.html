<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connexion LinkedIn</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .card { max-width: 720px; margin: 0 auto; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    input, button { padding: .6rem .8rem; font-size: 0.95rem; }
    button { cursor: pointer; }
  .muted { color: #6b7280; font-size: .9rem; }
    .ok { color: #059669; }
    .warn { color: #b45309; }
    .error { color: #dc2626; }
  .banner { padding: .8rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: .9rem; }
  .banner.warn { background: #fef3c7; color: #92400e; border: 1px solid #facc15; }
      /* Loader overlay */
      .overlay { position: fixed; inset: 0; background: rgba(255,255,255,.85); display:none; align-items:center; justify-content:center; z-index: 1000; }
      .spinner { width: 42px; height: 42px; border-radius: 50%; border: 4px solid #cbd5e1; border-top-color: #2563eb; animation: spin .9s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  <script>
    function b64e(str){ try { return btoa(unescape(encodeURIComponent(str))); } catch(_) { try { return btoa(str); } catch{ return str; } } }
    function b64d(str){ try { return decodeURIComponent(escape(atob(str))); } catch(_) { try { return atob(str); } catch { return str; } } }
    function loadStoredCreds(){
      try {
        const email = localStorage.getItem('li_email');
        const pwdEnc = localStorage.getItem('li_pwd');
        const emailEl = document.getElementById('loginEmail');
        const pwdEl = document.getElementById('loginPassword');
        const chkEmail = document.getElementById('rememberEmail');
        const chkPwd = document.getElementById('rememberPwd');
        if(email && emailEl){ emailEl.value = email; if(chkEmail) chkEmail.checked = true; }
        if(pwdEnc && pwdEl){ pwdEl.value = b64d(pwdEnc); if(chkPwd) chkPwd.checked = true; }
      } catch { /* ignore */ }
    }
    async function tryStoreWithCredentialsAPI(email, password){
      try {
        if (window.PasswordCredential && navigator.credentials) {
          const cred = new PasswordCredential({ id: email, password, name: 'LinkedIn' });
          await navigator.credentials.store(cred);
          return true;
        }
      } catch { /* ignore */ }
      return false;
    }
    async function saveCredentials(){
      const emailEl = document.getElementById('loginEmail');
      const pwdEl = document.getElementById('loginPassword');
      const chkEmail = document.getElementById('rememberEmail');
      const chkPwd = document.getElementById('rememberPwd');
      const email = (emailEl?.value || '').trim();
      const pwd = pwdEl?.value || '';
      if(!email){ alert('Veuillez saisir votre email.'); return; }
      try {
        if(chkEmail?.checked){ localStorage.setItem('li_email', email); } else { localStorage.removeItem('li_email'); }
        if(chkPwd?.checked && pwd){ localStorage.setItem('li_pwd', b64e(pwd)); } else { localStorage.removeItem('li_pwd'); }
        if(chkPwd?.checked && pwd){ await tryStoreWithCredentialsAPI(email, pwd); }
        // Silent success
      } catch(e){ /* ignore */ }
    }
    function clearCredentials(){
      try {
        localStorage.removeItem('li_email');
        localStorage.removeItem('li_pwd');
        const chkEmail = document.getElementById('rememberEmail');
        const chkPwd = document.getElementById('rememberPwd');
        if(chkEmail) chkEmail.checked = false;
        if(chkPwd) chkPwd.checked = false;
      } catch { /* ignore */ }
    }
    async function doLogin(ev) {
      ev.preventDefault();
      const fd = new FormData(ev.target);
      // Show loader overlay while Playwright opens LinkedIn and waits for auth/MFA
      const overlay = document.getElementById('overlay');
      overlay.style.display = 'flex';
      const btn = ev.target.querySelector('button[type="submit"]');
      if (btn) { btn.disabled = true; btn.textContent = 'Connexion en cours‚Ä¶'; }

      try {
        const res = await fetch('/api/session/login', { method:'POST', body: fd });
        if (res.ok) {
          // Persist creds locally if user opted in
          try { await saveCredentials(); } catch { }
          // Redirection automatique vers le dashboard sans alert
          location.href = '/?from=login';
          return;
        }

        let msg = 'Connexion impossible.';
        try {
          const j = await res.json();
          let d = (j && (j.detail !== undefined ? j.detail : j)) ?? null;
          if (typeof d === 'object' && d !== null) {
            msg = d.message || d.error || d.hint || d.detail || JSON.stringify(d);
          } else if (d !== null) {
            msg = String(d);
          }
        } catch(_) {
          try {
            const t = await res.text();
            if (t) msg = t;
          } catch { /* ignore */ }
        }
        msg = `HTTP ${res.status} - ${msg}`;
        const errBox = document.getElementById('loginError');
        if (errBox) { errBox.textContent = '√âchec de la connexion. ' + msg; errBox.style.display = 'block'; }
        else { alert('√âchec de la connexion. ' + msg); }
      } catch (e) {
        const errBox = document.getElementById('loginError');
        const msg = 'Erreur r√©seau: ' + e;
        if (errBox) { errBox.textContent = '√âchec de la connexion. ' + msg; errBox.style.display = 'block'; }
        else { alert('√âchec de la connexion. ' + msg); }
      } finally {
        overlay.style.display = 'none';
        if (btn) { btn.disabled = false; btn.textContent = 'Se connecter'; }
      }
    }
  </script>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
</head>
<body>
  <div class="card">
    <h1>Connexion LinkedIn requise</h1>
    {% if reason_message %}
      <div class="banner warn">{{ reason_message }}</div>
    {% endif %}
    {% if valid %}
      <p class="ok">Une session semble valide. <a href="/">Aller au tableau de bord</a></p>
    {% else %}
        <p class="muted">Connectez-vous via Playwright. Une fen√™tre LinkedIn va s'ouvrir ‚Äî merci de patienter et compl√©tez les √©tapes directement sur LinkedIn (MFA/CAPTCHA le cas √©ch√©ant).</p>
        <div id="loginError" class="banner" style="display:none;background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;"></div>
        <h3>Connexion via Playwright</h3>
      <form onsubmit="doLogin(event)" autocomplete="on">
        <div class="row">
          <input id="loginEmail" name="email" type="email" placeholder="Email" required autocomplete="username email" />
          <input id="loginPassword" name="password" type="password" placeholder="Mot de passe" required autocomplete="current-password" />
        </div>
        <div style="margin-top:.6rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
          <label style="display:flex; align-items:center; gap:.4rem;">
            <input id="rememberEmail" type="checkbox" checked />
            <span>Se souvenir de l'e‚Äëmail</span>
          </label>
          <label style="display:flex; align-items:center; gap:.4rem;">
            <input id="rememberPwd" type="checkbox" />
            <span>Se souvenir du mot de passe (local)</span>
          </label>
        </div>
        <div style="margin-top:.8rem; padding:.8rem; background:#eff6ff; border:1px solid #93c5fd; border-radius:8px;">
          <label style="display:flex; align-items:center; gap:.5rem; cursor:pointer;">
            <input id="saveForAutoReconnect" name="save_credentials" type="checkbox" value="true" checked />
            <span style="font-weight:500; color:#1e40af;">üîÑ Activer la reconnexion automatique</span>
          </label>
          <div class="muted" style="margin-top:.25rem; font-size:.85rem; color:#3b82f6;">
            Si LinkedIn r√©voque votre session, l'application se reconnectera automatiquement avec vos identifiants.
            <br>‚ö†Ô∏è Si un code MFA (2FA) est demand√©, vous devrez vous reconnecter manuellement.
          </div>
        </div>
        <div class="muted" style="margin-top:.5rem; font-size:.8rem;">
          Les identifiants sont chiffr√©s localement (DPAPI Windows) et ne quittent jamais votre machine.
        </div>
        <div style="margin-top:.8rem; display:flex; gap:.5rem; flex-wrap:wrap;">
          <button type="submit">Se connecter</button>
        </div>
      </form>
    {% endif %}
  </div>
    <!-- Full-screen loader overlay displayed during Playwright login -->
    <div id="overlay" class="overlay">
      <div style="display:flex;flex-direction:column;align-items:center;gap:.75rem;">
        <div class="spinner" aria-label="chargement"></div>
        <div class="muted" style="text-align:center;max-width:460px;">
          Ouverture de LinkedIn‚Ä¶ merci de patienter et d'accepter les √©tapes d'authentification si n√©cessaire (MFA/CAPTCHA).
        </div>
      </div>
    </div>
</body>
<script>
  try { loadStoredCreds(); } catch {}
  // Autofocus email if empty, otherwise password
  (function(){
    const emailEl = document.getElementById('loginEmail');
    const pwdEl = document.getElementById('loginPassword');
    if(emailEl && !emailEl.value) emailEl.focus();
    else if(pwdEl) pwdEl.focus();
  })();
  // Attempt automatic login when the user opted to remember both email and password
  // NOTE: pas d'auto-login au chargement.
</script>
</html>
