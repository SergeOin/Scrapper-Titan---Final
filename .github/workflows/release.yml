name: release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      DAILY_POST_TARGET: "50"
      BOOSTER_ACTIVATE_RATIO: "0.6"
      BOOSTER_KEYWORDS: recrute;offre;hiring;opportunité;juriste;avocat
      RELAX_FILTERS_BELOW_TARGET: "1"
      ADAPTIVE_SCROLL: "1"
      ADAPTIVE_SCROLL_MAX: "8"
      MAX_SCROLL_STEPS: "6"
      MAX_POSTS_PER_KEYWORD: "35"
      GLOBAL_RATE_LIMIT_PER_MIN: "140"
      RATE_LIMIT_REFILL_PER_SEC: "2.5"
      PER_KEYWORD_DELAY_MS: "400"
      ADAPTIVE_PAUSE_EVERY: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install WiX Toolset
        shell: pwsh
        run: |
          choco install wixtoolset --version=3.14.1 -y
          Get-Command candle.exe; Get-Command light.exe
      - name: Build EXE + MSI
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          Write-Host "Building version $version"
          # Generate icon if missing
          if (!(Test-Path build/icon.ico) -and (Test-Path 'Titan Scraper logo.png')) {
            py -3 scripts/util_make_icon.py -i 'Titan Scraper logo.png' -o build/icon.ico
          }
          # Build desktop app (PyInstaller)
          pwsh ./build_windows.ps1
          # Optional code signing setup
          if($env:WINDOWS_CERT_PFX -and $env:WINDOWS_CERT_PASSWORD){
            Write-Host "Code signing secrets detected: will sign binaries." -ForegroundColor Cyan
            $pfxPath = Join-Path $env:RUNNER_TEMP 'codesign.pfx'
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_CERT_PFX))
            $signArgs = "-Sign -CertPfxPath `"$pfxPath`" -CertPfxPassword `"$env:WINDOWS_CERT_PASSWORD`""
          } else { $signArgs = "" }
          # Build MSI from dist/TitanScraper with architecture suffix
          $cmd = ".\scripts\build_msi_folder.ps1 -Version $version -Name TitanScraper -ExeName TitanScraper.exe"
          if($signArgs){ $cmd += " $signArgs" }
          pwsh -NoProfile -ExecutionPolicy Bypass -Command $cmd
          # Create portable ZIP
          if(Test-Path dist/TitanScraper){
            Compress-Archive -Path dist/TitanScraper/* -DestinationPath build/TitanScraper-$version-portable.zip -Force
          }
          # SBOM (Windows) - pip cyclonedx plugin
          python -m pip install cyclonedx-bom==3.19.6 || echo "CycloneDX install skipped"
          if (Test-Path requirements.txt) { python -m cyclonedx_py requirements -i requirements.txt -o build/sbom-windows.json || echo "SBOM generation failed" }
          Write-Host "--- BUILD DIR CONTENTS ---"
          Get-ChildItem build -Recurse | ForEach-Object { Write-Host $_.FullName }
          Write-Host "--- DIST DIR CONTENTS ---"
          if(Test-Path dist){ Get-ChildItem dist -Recurse | ForEach-Object { Write-Host $_.FullName } } else { Write-Host 'dist missing' }
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            dist/TitanScraper/**
            dist/msi/*.msi
            build/msi/*.msi # (fallback if script output path changes)
            build/*-portable.zip
            dist/*.exe
            dist/**/*.dll
  build-macos:
    runs-on: macos-latest
    env:
      DAILY_POST_TARGET: "50"
      BOOSTER_ACTIVATE_RATIO: "0.6"
      BOOSTER_KEYWORDS: recrute;offre;hiring;opportunité;juriste;avocat
      RELAX_FILTERS_BELOW_TARGET: "1"
      ADAPTIVE_SCROLL: "1"
      ADAPTIVE_SCROLL_MAX: "8"
      MAX_SCROLL_STEPS: "6"
      MAX_POSTS_PER_KEYWORD: "35"
      GLOBAL_RATE_LIMIT_PER_MIN: "140"
      RATE_LIMIT_REFILL_PER_SEC: "2.5"
      PER_KEYWORD_DELAY_MS: "400"
      ADAPTIVE_PAUSE_EVERY: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build app + DMG
        run: |
          chmod +x build_mac.sh
          ./build_mac.sh
          chmod +x scripts/build_dmg.sh
          set -e
          VERSION="${GITHUB_REF_NAME#v}" scripts/build_dmg.sh "${GITHUB_REF_NAME#v}"
          echo '--- dist contents (macOS) ---'
          ls -R dist || true
      - name: Generate SBOM (macOS)
        run: |
          python3 -m pip install cyclonedx-bom==3.19.6 || echo "CycloneDX install skipped"
          if [ -f requirements.txt ]; then python3 -m cyclonedx_py requirements -i requirements.txt -o build/sbom-macos.json || echo "SBOM generation failed"; fi
      # (Signature macOS optionnelle supprimée pour simplicité; réintroduire ici si nécessaire.)
      # Signing / Notarization template (commented to avoid secret lint issues until secrets are configured)
      # To enable: replace SECRET_* placeholders with real ${{ secrets.* }} references and uncomment blocks.
      # - name: Import signing certificate
      #   run: |
      #     echo "$SECRET_MACOS_CERT_P12_B64" | base64 --decode > signing_cert.p12
      #     security create-keychain -p temp build.keychain
      #     security import signing_cert.p12 -k build.keychain -P "$SECRET_MACOS_CERT_PASSWORD" -T /usr/bin/codesign
      #     security list-keychain -d user -s build.keychain
      #     security unlock-keychain -p temp build.keychain
      #     security set-key-partition-list -S apple-tool:,apple: -s -k temp build.keychain
      # - name: Codesign .app bundle
      #   run: |
      #     APP=$(find dist -maxdepth 2 -name '*.app' | head -n1)
      #     codesign --force --deep --timestamp --options runtime --sign "Developer ID Application" "$APP"
      #     codesign --verify --deep --strict "$APP" || true
      # - name: Notarize app
      #   run: |
      #     APP=$(find dist -maxdepth 2 -name '*.app' | head -n1)
      #     ZIP=app_for_notarization.zip
      #     ditto -c -k --keepParent "$APP" "$ZIP"
      #     xcrun notarytool submit "$ZIP" --apple-id "$SECRET_APPLE_NOTARIZATION_APPLE_ID" --team-id "$SECRET_APPLE_NOTARIZATION_TEAM_ID" --password "$SECRET_APPLE_NOTARIZATION_PASSWORD" --wait || echo "Notarization failed or skipped"
      #     xcrun stapler staple "$APP" || echo "Stapler failed"
      # - name: Codesign DMG (optional)
      #   run: |
      #     DMG=$(find build -maxdepth 1 -name '*.dmg' | head -n1)
      #     if [ -n "$DMG" ]; then codesign --force --timestamp --sign "Developer ID Application" "$DMG" || echo "DMG sign skipped"; fi
      # - name: Codesign & Notarize (optional)
      #   env:
      #     MAC_IDENTITY_NAME: ${{ secrets.MAC_IDENTITY_NAME }}
      #     MAC_SIGNING_CERT_P12: ${{ secrets.MAC_SIGNING_CERT_P12 }}
      #     MAC_SIGNING_CERT_PASSWORD: ${{ secrets.MAC_SIGNING_CERT_PASSWORD }}
      #     MAC_NOTARIZATION_APPLE_ID: ${{ secrets.MAC_NOTARIZATION_APPLE_ID }}
      #     MAC_NOTARIZATION_PASSWORD: ${{ secrets.MAC_NOTARIZATION_PASSWORD }}
      #     MAC_TEAM_ID: ${{ secrets.MAC_TEAM_ID }}
      #   run: |
      #     if [ -n "$MAC_IDENTITY_NAME" ] && [ -n "$MAC_SIGNING_CERT_P12" ] && [ -n "$MAC_SIGNING_CERT_PASSWORD" ]; then
      #       echo "$MAC_SIGNING_CERT_P12" | base64 --decode > signing_cert.p12
      #       security create-keychain -p temp build.keychain
      #       security import signing_cert.p12 -k build.keychain -P "$MAC_SIGNING_CERT_PASSWORD" -T /usr/bin/codesign
      #       security list-keychain -d user -s build.keychain
      #       security unlock-keychain -p temp build.keychain
      #       /usr/bin/codesign --force --deep --timestamp --options runtime --sign "$MAC_IDENTITY_NAME" dist/LinkedInScraper/LinkedInScraper || true
      #     else
      #       echo "Codesign secrets absent -> skipping signing"; fi
      #     if [ -n "$MAC_NOTARIZATION_APPLE_ID" ] && [ -n "$MAC_NOTARIZATION_PASSWORD" ] && [ -n "$MAC_TEAM_ID" ]; then
      #       echo "Submitting for notarization (simplified)" || true
      #       # xcrun notarytool submit build/*.dmg --apple-id "$MAC_NOTARIZATION_APPLE_ID" --password "$MAC_NOTARIZATION_PASSWORD" --team-id "$MAC_TEAM_ID" --wait || true
      #     else
      #       echo "Notarization secrets absent -> skipping"; fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: |
            dist/TitanScraper/**
            dist/*.dmg
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Debug list downloaded artifacts (initial)
        run: |
          echo '--- Tree of artifacts (depth 4) ---'
          find artifacts -maxdepth 4 -type f -printf '%P\n' | sort
          echo '--- End tree ---'
      - name: Assert critical assets exist
        run: |
          set -e
          echo 'Checking MSI presence...'
          ls artifacts/windows-binaries/dist/msi/*.msi || { echo 'MSI not found'; exit 1; }
          echo 'Checking DMG presence...'
          ls artifacts/macos-binaries/dist/*.dmg || { echo 'DMG not found'; exit 1; }
          echo 'MSI & DMG OK'
      - name: Generate checksums
        run: |
          set -e
          mkdir -p checksum
          echo "Generating SHA256 sums for release assets" 
          find artifacts -type f \( -name '*.msi' -o -name '*.dmg' -o -name '*.exe' \) -print0 | xargs -0 -I{} sh -c 'sha256sum "{}" >> checksum/checksums.txt'
          sort checksum/checksums.txt -o checksum/checksums.txt
          echo "--- checksums.txt ---" && cat checksum/checksums.txt
      - name: Aggregate SBOMs
        run: |
          mkdir -p sbom
          # Collect SBOMs if present from both OS jobs
          find artifacts -type f -name 'sbom-*.json' -exec cp {} sbom/ \; || true
          if [ -d sbom ]; then ls -1 sbom || true; fi
      - name: Merge SBOMs (CycloneDX)
        run: |
          set -e
          if ls sbom/sbom-*.json 1>/dev/null 2>&1; then
            pip install cyclonedx-bom==3.19.6 jq -q || true
            # Simple merge: concat components uniques (approche basique si cyclonedx-cli absent)
            if pip show cyclonedx-bom >/dev/null 2>&1; then
              # Fallback simple: prendre le premier comme base et ajouter manuellement composants uniques
              base=$(ls sbom/sbom-*.json | head -n1)
              cp "$base" sbom/sbom-merged.json
              # Tentative merge naïf (jq) – si structure standard
              if command -v jq >/dev/null 2>&1; then
                for f in sbom/sbom-*.json; do
                  jq -s '.[0] as $a | (.[1:][] | .components // []) as $b | $a.components += $b | $a | .components |= (unique_by(.name,.version,.purl))' "$f" sbom/sbom-merged.json >/dev/null 2>&1 || true
                done
              fi
            fi
          else
            echo "No individual SBOMs to merge"
          fi
          ls -1 sbom || true
      - name: Security Scan (OSV) minimal
        run: |
          pip install pip-audit==2.7.3 || true
          pip-audit -r requirements.txt -f json > sbom/osv-report.json || echo "pip-audit failed (non-blocking)"
      - name: (Optional) Trivy Scan
        run: |
          echo "Skipping Trivy full scan (enable by installing trivy)."
          # Example (commented):
          # curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy
          # ./trivy fs --format json --output sbom/trivy-fs.json . || true
      - name: Export provenance JSON copy
        run: |
          # Placeholder provenance JSON (human-readable, separate from attestation)
          mkdir -p sbom
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo '{'                         > sbom/provenance.json
          echo '  "schemaVersion": "1.0",' >> sbom/provenance.json
          echo '  "build": {'              >> sbom/provenance.json
          echo '    "tag": "'${GITHUB_REF_NAME}'",' >> sbom/provenance.json
          echo '    "commit": "'${GITHUB_SHA}'",'   >> sbom/provenance.json
          echo '    "timestamp": "'${TS}'",'        >> sbom/provenance.json
          echo '    "runner_os": "'${RUNNER_OS}'",' >> sbom/provenance.json
          echo '    "includes": ["msi","dmg","exe","sbom","checksums"]' >> sbom/provenance.json
          echo '  }' >> sbom/provenance.json
          echo '}'   >> sbom/provenance.json
          cat sbom/provenance.json
      - name: Generate provenance attestation (Alpha)
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: |
            artifacts/windows-binaries/dist/msi/*.msi
            artifacts/macos-binaries/dist/*.dmg
      - name: Generate per-file sha256 sidecar files
        run: |
          echo "Generating individual .sha256 files"
          find artifacts -type f \( -name '*.msi' -o -name '*-portable.zip' -o -name '*.dmg' -o -name '*.exe' \) -print0 | while IFS= read -r -d '' f; do
            sha256sum "$f" > "$f.sha256" || true
          done
          echo "Listing generated sidecar hashes:" || true
          find artifacts -type f -name '*.sha256' -maxdepth 6 | sed 's|^|HASH: |'
      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksum/checksums.txt
      - name: Generate download manifest
        run: |
          echo "TitanScraper - Assets ${GITHUB_REF_NAME}" > artifacts/DOWNLOADS.txt
          echo "" >> artifacts/DOWNLOADS.txt
          echo "MSI Windows :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/windows-binaries/dist/msi/*.msi 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          ls -1 artifacts/windows-binaries/build/msi/*.msi 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "Binaire Windows (dossier dist) :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/windows-binaries/dist/TitanScraper/* 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "Portable ZIP :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/windows-binaries/build/*-portable.zip 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "DMG macOS :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/macos-binaries/dist/*.dmg 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "SHA256 checksums dans checksums.txt" >> artifacts/DOWNLOADS.txt
      - name: Extract changelog section
        id: changelog
        run: |
          version="${GITHUB_REF_NAME#v}"
          awk -v ver="$version" 'BEGIN{found=0} /^## \[/ { if(found) exit } { if(index($0, "["ver"]")>0) found=1 } { if(found) print }' CHANGELOG.md > extracted_changelog.md || true
          echo '--- extracted changelog ---'
          cat extracted_changelog.md || true
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat extracted_changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: true
          prerelease: false
          body: ${{ steps.changelog.outputs.body }}
          files: |
            artifacts/windows-binaries/dist/msi/*.msi
            artifacts/windows-binaries/build/msi/*.msi
            artifacts/windows-binaries/dist/TitanScraper/**
            artifacts/windows-binaries/build/*-portable.zip
            artifacts/macos-binaries/dist/*.dmg
            checksum/checksums.txt
            artifacts/DOWNLOADS.txt
            artifacts/**/*.sha256
            artifacts/windows-binaries/dist/**/*.exe
            artifacts/windows-binaries/dist/**/*.dll
            artifacts/windows-binaries/**/*.zip
            artifacts/macos-binaries/dist/**/*.app
            sbom/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
