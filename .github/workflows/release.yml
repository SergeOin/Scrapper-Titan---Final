name: build-release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install WiX Toolset
        uses: wixtoolset/wix-action@v1.1
      - name: Build EXE + MSI
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          Write-Host "Building version $version"
          # Generate icon if missing
          if (!(Test-Path build/icon.ico) -and (Test-Path 'Titan Scraper logo.png')) {
            py -3 scripts/util_make_icon.py -i 'Titan Scraper logo.png' -o build/icon.ico
          }
          # Build desktop app (PyInstaller)
          pwsh ./build_windows.ps1
          # Optional code signing setup
          if($env:WINDOWS_CERT_PFX -and $env:WINDOWS_CERT_PASSWORD){
            Write-Host "Code signing secrets detected: will sign binaries." -ForegroundColor Cyan
            $pfxPath = Join-Path $env:RUNNER_TEMP 'codesign.pfx'
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_CERT_PFX))
            $signArgs = "-Sign -CertPfxPath `"$pfxPath`" -CertPfxPassword `"$env:WINDOWS_CERT_PASSWORD`""
          } else { $signArgs = "" }
          # Build MSI from dist/TitanScraper with architecture suffix
          $cmd = ".\scripts\build_msi_folder.ps1 -Version $version -Name TitanScraper -ExeName TitanScraper.exe"
          if($signArgs){ $cmd += " $signArgs" }
          pwsh -NoProfile -ExecutionPolicy Bypass -Command $cmd
          # Create portable ZIP
          if(Test-Path dist/TitanScraper){
            Compress-Archive -Path dist/TitanScraper/* -DestinationPath build/TitanScraper-$version-portable.zip -Force
          }
          Get-ChildItem build -Recurse | Write-Host
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            dist/TitanScraper/**
            dist/msi/*.msi
            build/msi/*.msi # (fallback if script output path changes)
            build/*-portable.zip
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build app + DMG
        run: |
          chmod +x build_mac.sh
          ./build_mac.sh
          chmod +x scripts/build_dmg.sh
          VERSION="${GITHUB_REF_NAME#v}" scripts/build_dmg.sh "${GITHUB_REF_NAME#v}" || true
          ls -R dist || true
      # Signing / Notarization template (commented to avoid secret lint issues until secrets are configured)
      # To enable: replace SECRET_* placeholders with real ${{ secrets.* }} references and uncomment blocks.
      # - name: Import signing certificate
      #   run: |
      #     echo "$SECRET_MACOS_CERT_P12_B64" | base64 --decode > signing_cert.p12
      #     security create-keychain -p temp build.keychain
      #     security import signing_cert.p12 -k build.keychain -P "$SECRET_MACOS_CERT_PASSWORD" -T /usr/bin/codesign
      #     security list-keychain -d user -s build.keychain
      #     security unlock-keychain -p temp build.keychain
      #     security set-key-partition-list -S apple-tool:,apple: -s -k temp build.keychain
      # - name: Codesign .app bundle
      #   run: |
      #     APP=$(find dist -maxdepth 2 -name '*.app' | head -n1)
      #     codesign --force --deep --timestamp --options runtime --sign "Developer ID Application" "$APP"
      #     codesign --verify --deep --strict "$APP" || true
      # - name: Notarize app
      #   run: |
      #     APP=$(find dist -maxdepth 2 -name '*.app' | head -n1)
      #     ZIP=app_for_notarization.zip
      #     ditto -c -k --keepParent "$APP" "$ZIP"
      #     xcrun notarytool submit "$ZIP" --apple-id "$SECRET_APPLE_NOTARIZATION_APPLE_ID" --team-id "$SECRET_APPLE_NOTARIZATION_TEAM_ID" --password "$SECRET_APPLE_NOTARIZATION_PASSWORD" --wait || echo "Notarization failed or skipped"
      #     xcrun stapler staple "$APP" || echo "Stapler failed"
      # - name: Codesign DMG (optional)
      #   run: |
      #     DMG=$(find build -maxdepth 1 -name '*.dmg' | head -n1)
      #     if [ -n "$DMG" ]; then codesign --force --timestamp --sign "Developer ID Application" "$DMG" || echo "DMG sign skipped"; fi
      # - name: Codesign & Notarize (optional)
      #   env:
      #     MAC_IDENTITY_NAME: ${{ secrets.MAC_IDENTITY_NAME }}
      #     MAC_SIGNING_CERT_P12: ${{ secrets.MAC_SIGNING_CERT_P12 }}
      #     MAC_SIGNING_CERT_PASSWORD: ${{ secrets.MAC_SIGNING_CERT_PASSWORD }}
      #     MAC_NOTARIZATION_APPLE_ID: ${{ secrets.MAC_NOTARIZATION_APPLE_ID }}
      #     MAC_NOTARIZATION_PASSWORD: ${{ secrets.MAC_NOTARIZATION_PASSWORD }}
      #     MAC_TEAM_ID: ${{ secrets.MAC_TEAM_ID }}
      #   run: |
      #     if [ -n "$MAC_IDENTITY_NAME" ] && [ -n "$MAC_SIGNING_CERT_P12" ] && [ -n "$MAC_SIGNING_CERT_PASSWORD" ]; then
      #       echo "$MAC_SIGNING_CERT_P12" | base64 --decode > signing_cert.p12
      #       security create-keychain -p temp build.keychain
      #       security import signing_cert.p12 -k build.keychain -P "$MAC_SIGNING_CERT_PASSWORD" -T /usr/bin/codesign
      #       security list-keychain -d user -s build.keychain
      #       security unlock-keychain -p temp build.keychain
      #       /usr/bin/codesign --force --deep --timestamp --options runtime --sign "$MAC_IDENTITY_NAME" dist/LinkedInScraper/LinkedInScraper || true
      #     else
      #       echo "Codesign secrets absent -> skipping signing"; fi
      #     if [ -n "$MAC_NOTARIZATION_APPLE_ID" ] && [ -n "$MAC_NOTARIZATION_PASSWORD" ] && [ -n "$MAC_TEAM_ID" ]; then
      #       echo "Submitting for notarization (simplified)" || true
      #       # xcrun notarytool submit build/*.dmg --apple-id "$MAC_NOTARIZATION_APPLE_ID" --password "$MAC_NOTARIZATION_PASSWORD" --team-id "$MAC_TEAM_ID" --wait || true
      #     else
      #       echo "Notarization secrets absent -> skipping"; fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: |
            dist/TitanScraper/**
            dist/*.dmg
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Generate checksums
        run: |
          set -e
          mkdir -p checksum
          echo "Generating SHA256 sums for release assets" 
          find artifacts -type f \( -name '*.msi' -o -name '*.dmg' -o -name '*.exe' \) -print0 | xargs -0 -I{} sh -c 'sha256sum "{}" >> checksum/checksums.txt'
          sort checksum/checksums.txt -o checksum/checksums.txt
          echo "--- checksums.txt ---" && cat checksum/checksums.txt
      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksum/checksums.txt
      - name: Generate download manifest
        run: |
          echo "TitanScraper - Assets ${GITHUB_REF_NAME}" > artifacts/DOWNLOADS.txt
          echo "" >> artifacts/DOWNLOADS.txt
          echo "MSI Windows :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/windows-binaries/dist/msi/*.msi 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          ls -1 artifacts/windows-binaries/build/msi/*.msi 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "Binaire Windows (dossier dist) :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/windows-binaries/dist/TitanScraper/* 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "Portable ZIP :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/windows-binaries/build/*-portable.zip 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "DMG macOS :" >> artifacts/DOWNLOADS.txt
          ls -1 artifacts/macos-binaries/dist/*.dmg 2>/dev/null >> artifacts/DOWNLOADS.txt || true
          echo "" >> artifacts/DOWNLOADS.txt
          echo "SHA256 checksums dans checksums.txt" >> artifacts/DOWNLOADS.txt
      - name: Extract changelog section
        id: changelog
        run: |
          version="${GITHUB_REF_NAME#v}"
          awk -v ver="$version" 'BEGIN{found=0} /^## \[/ { if(found) exit } { if(index($0, "["ver"]")>0) found=1 } { if(found) print }' CHANGELOG.md > extracted_changelog.md || true
          echo '--- extracted changelog ---'
          cat extracted_changelog.md || true
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat extracted_changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: ${{ steps.changelog.outputs.body }}
          files: |
            artifacts/windows-binaries/dist/msi/*.msi
            artifacts/windows-binaries/build/msi/*.msi
            artifacts/windows-binaries/dist/TitanScraper/**
            artifacts/windows-binaries/build/*-portable.zip
            artifacts/macos-binaries/dist/*.dmg
            checksum/checksums.txt
            artifacts/DOWNLOADS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
