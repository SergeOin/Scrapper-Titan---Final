#############################
# DEACTIVATED WORKFLOW FILE #
# Original: nightly-classifier-report.yml
# Reason: User requested total removal of all workflows.
# Date: 2025-10-08
# All triggers and jobs removed intentionally.
#############################
name: nightly-classifier-report

on:
  schedule:
    - cron: '15 2 * * *'  # 02:15 UTC daily
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
      - name: Generate classifier report
        env:
          MONGO_DB: linkedin_scrape
          MONGO_COLLECTION_POSTS: posts
        run: |
          # MONGO_URI secret optional; if unavailable script falls back to SQLite
          python scripts/classifier_report.py > classifier_report.json || echo '{}' > classifier_report.json
      - name: Extract metrics & prepare body
        run: |
          python -c "import json,pathlib; p=pathlib.Path('classifier_report.json');\nimport sys;\n\n\n j=json.loads(p.read_text(encoding='utf-8')) if p.exists() else {}; b=['# Nightly Classifier Report','',f'Generated: {j.get('generated_at','unknown')}',f'Sample Size: {j.get('total_sample')}',f'Rejection Ratio (autre): {j.get('rejection_ratio')}',f'Mean Relevance: {j.get('mean_relevance')}',f'Median Relevance: {j.get('median_relevance')}', '', 'Intent Distribution:'];\n\n\n ints=j.get('intents',{});\n\n\n [b.append(f'- {k}: {v}') for k,v in sorted(ints.items(), key=lambda x:-x[1])]; b.append(''); b.append('Raw JSON attached as artifact.'); pathlib.Path('body.txt').write_text('\n'.join(b),encoding='utf-8')"
      - name: Upload raw report artifact
        uses: actions/upload-artifact@v4
        with:
          name: nightly-classifier-report
          path: |
            classifier_report.json
            body.txt
      - name: Prepare issue update payload
        run: |
          python -c "import json,pathlib;body=pathlib.Path('body.txt').read_text(encoding='utf-8') if pathlib.Path('body.txt').exists() else 'Nightly report body missing.';payload={'title':'Nightly Classifier Report','body':body+'\n\n(Automated update - do not edit manually)','labels':['report','automation']};pathlib.Path('payload.json').write_text(json.dumps(payload),encoding='utf-8');print('Payload prepared for Issue #1 update.')"
      - name: Update Issue #1 (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/1 | grep -q 200; then
            echo "Issue #1 exists â€“ updating body.";
            curl -s -X PATCH -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/1 -d @payload.json > /dev/null || echo "Warning: failed to patch issue #1";
          else
            echo "Issue #1 does not exist. Please create an issue titled 'Nightly Classifier Report' manually once. Skipping update.";
          fi
      - name: Prune duplicate Nightly issues (close extras)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Searching for duplicate Nightly Classifier Report issues..."
          curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/search/issues?q=repo:${GITHUB_REPOSITORY}+is:issue+in:title+%22Nightly+Classifier+Report%22" > search.json || echo '{"items":[]}' > search.json
          python -c "import json,os,subprocess;data=json.load(open('search.json'));dups=[i['number'] for i in data.get('items',[]) if i.get('number')!=1];\nprint('Duplicates to close:' if dups else 'No duplicates found.', dups);[subprocess.run(['bash','-lc',f\"curl -s -X PATCH -H 'Authorization: Bearer {os.environ['GITHUB_TOKEN']}' -H 'Accept: application/vnd.github+json' https://api.github.com/repos/{os.environ['GITHUB_REPOSITORY']}/issues/{n} -d '{{\\\"state\\\":\\\"closed\\\",\\\"state_reason\\\":\\\"not_planned\\\"}}' > /dev/null\"]) for n in dups]"
