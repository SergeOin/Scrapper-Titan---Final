name: nightly-classifier-report

on:
  schedule:
    - cron: '15 2 * * *'  # 02:15 UTC daily
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
      - name: Generate classifier report
        env:
          MONGO_DB: linkedin_scrape
          MONGO_COLLECTION_POSTS: posts
        run: |
          # MONGO_URI secret optional; if unavailable script falls back to SQLite
          python scripts/classifier_report.py > classifier_report.json || echo '{}' > classifier_report.json
      - name: Extract metrics & prepare body
        run: |
          python -c "import json,pathlib; p=pathlib.Path('classifier_report.json');\nimport sys;\n\n\n j=json.loads(p.read_text(encoding='utf-8')) if p.exists() else {}; b=['# Nightly Classifier Report','',f'Generated: {j.get('generated_at','unknown')}',f'Sample Size: {j.get('total_sample')}',f'Rejection Ratio (autre): {j.get('rejection_ratio')}',f'Mean Relevance: {j.get('mean_relevance')}',f'Median Relevance: {j.get('median_relevance')}', '', 'Intent Distribution:'];\n\n\n ints=j.get('intents',{});\n\n\n [b.append(f'- {k}: {v}') for k,v in sorted(ints.items(), key=lambda x:-x[1])]; b.append(''); b.append('Raw JSON attached as artifact.'); pathlib.Path('body.txt').write_text('\n'.join(b),encoding='utf-8')"
      - name: Upload raw report artifact
        uses: actions/upload-artifact@v4
        with:
          name: nightly-classifier-report
          path: |
            classifier_report.json
            body.txt
      - name: Create issue (idempotent best-effort)
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'Nightly Classifier Report'
          content-filepath: body.txt
          labels: report,automation
